"""
core_types.py

このファイルは、プロジェクトで共通して使う
「データの形」をまとめておく場所です。

たとえるなら、
・文書の情報はこういう形で持ちますよ
・チャンク（文書の一部分）はこういう形ですよ
という “設計図（データの型）” を作っています。

これを用意しておくと、
バックエンド extractor / embedder / persistence の3つが
同じ形のデータをやりとりできるようになります。
"""

from __future__ import annotations   # 型ヒントをシンプルに書けるようにするためのおまじない
from dataclasses import dataclass    # データを入れる箱（クラス）を簡単につくるための道具


# -------------------------------------------------------------------
# 文書（PDF全体）の情報をまとめるためのデータ型
# -------------------------------------------------------------------

@dataclass
class DocumentMeta:
    """
    文書そのものの情報をまとめて持つためのデータ型です。

    例：
      - ファイル名
      - MIMEタイプ（PDFかどうか）
      - ページ数
      - タグ（AIで自動抽出など）

    バックエンド extractor が PDFから情報を取り出したときに、
    この形で返すイメージです。
    """

    original_filename: str   # アップロードしたときのファイル名（例: "test.pdf"）
    mime_type: str           # ファイル形式を表す文字列（例: "application/pdf"）
    page_count: int | None = None   # ページ数。分からなければ None
    tags: list | None = None        # 文書全体につくタグ（例: ["USB", "仕様書"]）



# -------------------------------------------------------------------
# 文書を小さく分解した「チャンク」の情報（embedding前）
# -------------------------------------------------------------------

@dataclass
class Chunk:
    """
    文書を小さく分割した単位を「チャンク」と呼びます。

    例：
      - 1段落ごと
      - 一定文字数ごと
      - 章や節ごと

    チャンクには「テキスト」と「どのページにあったか」などの
    メタデータ（補足情報）を含めることができます。
    """

    chunk_index: int    # 文書内での順番（0,1,2,...）
    text: str           # このチャンクの本文テキスト
    metadata: dict      # ページ番号や見出しなど（{"page":1, "heading":"概要"} のような形）



# -------------------------------------------------------------------
# ベクトル（embedding）付きのチャンク情報（embedding後）
# -------------------------------------------------------------------

@dataclass
class EmbeddedChunk:
    """
    チャンクに「意味ベクトル（embedding）」をつけたデータ型です。

    これはバックエンド embedder が作成します。

    embedding とは？
    → AIモデルに文章を食わせることで得られる “数値のリスト”（特徴ベクトル）
      例： [0.123, -0.88, 0.004, ...] のような数値の配列
    """

    chunk_index: int
    text: str
    metadata: dict
    embedding: list    # ベクトル（例：長さ1536の数値リスト）



# -------------------------------------------------------------------
# 文書1つの処理が終わったときの結果をまとめるデータ型
# -------------------------------------------------------------------

@dataclass
class DocumentProcessResult:
    """
    main.py（オーケストレーター）が
    「文書1つの処理が終わったよ！」という時に返す結果。

    フロントエンドや他の処理から見て、
    ・どの文書IDが作られた？
    ・チャンクはいくつ保存された？
    が分かれば十分なので、この形にまとめています。
    """

    document_id: int   # DB上での文書ID
    chunks_saved: int  # 保存されたチャンクの件数
